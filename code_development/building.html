

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Building scientific software &mdash; Sigma2/Metacenter documentation  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Compilers" href="compilers.html" />
    <link rel="prev" title="Storage performance tuning" href="../files_storage/performance.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> Sigma2/Metacenter documentation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">News</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://opslog.sigma2.no">Latest changes and events</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.sigma2.no/hardware-status">Hardware live status</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting help</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/support_line.html">Support line</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/how_to_write_good_support_requests.html">Writing good support requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/qa-sessions.html">Open Question &amp; Answer Sessions for All Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/lost_forgotten_password.html">Lost or expiring password</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/project_leader_support.html">Project leader support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/advanced_user_support.html">Advanced User Support (AUS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/publish_research_data.html">Publish Research Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/course_resources.html">CRaaS - Course Resources as a Service</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../frontpage.html">The Norwegian Academic HPC Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/applying_account.html">How do I get an HPC account?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/applying_resources.html">Applying for computing and storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/training.html">Training material</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/create_ssh_keys.html">SSH</a></li>
</ul>
<p class="caption"><span class="caption-text">HPC Machines</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../hpc_machines/hardware_overview.html">Overview over our machines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hpc_machines/betzy.html">Betzy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hpc_machines/fram.html">Fram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hpc_machines/saga.html">Saga</a></li>
<li class="toctree-l1"><a class="reference external" href="https://hpc-uit.readthedocs.io">Stallo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hpc_machines/migration2metacenter.html">Migration to a Metacenter HPC machine</a></li>
</ul>
<p class="caption"><span class="caption-text">Software</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../software/modulescheme.html">Software Module Scheme</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/installed_software.html">Installed Software</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/containers.html">Running Singularity and Docker containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/appguides.html">Application guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/userinstallsw.html">How can I, as a user, install software for myself or my project with EasyBuild?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/userinstallsw.html#how-can-i-as-user-install-python-packages">How can I as user install Python packages?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/licenses.html">Licenses and access policies</a></li>
</ul>
<p class="caption"><span class="caption-text">Jobs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../jobs/submitting.html">Submitting jobs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jobs/choosing_job_types.html">Job Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jobs/job_scripts.html">Job Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jobs/running-scientific-software.html">Running scientific software</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jobs/monitoring.html">Monitoring jobs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jobs/choosing_memory_settings.html">How to choose the right amount of memory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jobs/common_job_failures.html">Common job failures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jobs/performance.html">How to check the performance and scaling using Arm Performance Reports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jobs/interactive_jobs.html">Interactive jobs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jobs/projects_accounting.html">Projects and accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jobs/network-access.html">No network access on compute nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jobs/dos_and_donts.html">Dos and Don’ts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jobs/guides.html">Guides</a></li>
</ul>
<p class="caption"><span class="caption-text">Files and Storage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/nird.html">NIRD - National Infrastructure for Research Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/clusters.html">Storage areas on HPC clusters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/backup.html">Backup on Betzy, Fram, Saga, and NIRD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/sharing_files.html">Data handling and storage policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/file_transfer.html">File transfer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/performance.html">Storage performance tuning</a></li>
</ul>
<p class="caption"><span class="caption-text">Code Development</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Building scientific software</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#compilers">Compilers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#intel">Intel</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#documentation">Documentation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#compiler-flags">Compiler flags</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#gnu">GNU</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">Documentation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">Compiler flags</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#amd-aocc-llvm">AMD AOCC/llvm</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id5">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">Documentation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">Compiler flags</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#pgi">PGI</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id8">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">Documentation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">Compiler flags</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#performance-of-compilers">Performance of compilers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#performance-libraries">Performance libraries</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#intel-mkl">Intel MKL</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id11">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id12">Documentation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#amd-aocl">AMD AOCL</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id13">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id14">Documentation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#performance">Performance</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#mpi-libraries">MPI libraries</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#openmpi">OpenMPI</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id15">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#usage">Usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#intel-mpi">Intel MPI</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id16">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id17">Usage</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="compilers.html">Compilers</a></li>
<li class="toctree-l1"><a class="reference internal" href="performance.html">Performance Analysis and Tuning</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Sigma2/Metacenter documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Building scientific software</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/UNINETTSigma2/documentation/blob/master/code_development/building.md" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="building-scientific-software">
<h1>Building scientific software<a class="headerlink" href="#building-scientific-software" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>This is just a quick short guide on the topic. For more in depth documentation please
check out the PRACE Best Practice Guides at:
https://prace-ri.eu/training-support/best-practice-guides/</p>
<p>Most relevant for Betzy :
https://prace-ri.eu/training-support/best-practice-guides/best-practice-guide-amd-epyc/
and an update covering AMD Rome named  “Best Practice Guide Modern Processors”
soon to be published.</p>
</div>
<div class="section" id="compilers">
<h2>Compilers<a class="headerlink" href="#compilers" title="Permalink to this headline">¶</a></h2>
<div class="section" id="intel">
<h3>Intel<a class="headerlink" href="#intel" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id1">
<h4>Introduction<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>The Intel compiler suite is supported on all Sigma2 systems. On the
systems Saga and Fram the processors are from Intel while the
processors on Betzy are from AMD. As the Intel compiler is primarily
compiler written fro the Intel processors there are some minor issues
when using it to build core for the AMD processors.</p>
</div>
<div class="section" id="documentation">
<h4>Documentation<a class="headerlink" href="#documentation" title="Permalink to this headline">¶</a></h4>
<p>The documentation of the Intel compiler are found at
<a class="reference external" href="https://software.intel.com/content/www/us/en/develop/tools/compilers.html">Intel compiler</a>
The web site is comprehensive and some browsing are required to find the needed documents.
Most users want to review the reference manual.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://software.intel.com/content/www/us/en/develop/documentation/cpp-compiler-developer-guide-and-reference/top.html">C/C++ reference</a></p></li>
<li><p><a class="reference external" href="https://software.intel.com/content/www/us/en/develop/tools/compilers/fortran-compilers/documentation.html">Fortran reference</a></p></li>
</ul>
</div>
<div class="section" id="compiler-flags">
<h4>Compiler flags<a class="headerlink" href="#compiler-flags" title="Permalink to this headline">¶</a></h4>
<p>The single most common question requested is a set of suggested
compiler flags. The Intel development team have already selected a
very good set of flags and just a simple <em>-O3</em> flag will provide quite
good choice.</p>
<p>The flag for OpenMP is very often needed : <em>-qopenmp</em> and must be used in both compiling a linking.</p>
<p>The optimisation flags are a bit more tricky. As all processors
support AVX2 this can always be used. A suggested list set of flags
than be tried might include:</p>
<ul class="simple">
<li><p>-O3</p></li>
<li><p>-O3 -xHost</p></li>
<li><p>-Ofast</p></li>
<li><p>-O3 -march=core-avx</p></li>
<li><p>-O3 -xavx</p></li>
<li><p>-O3 -xavx2</p></li>
<li><p>-O3 -xcore-avx2</p></li>
</ul>
<p>The flags above have been tested and yield good results. On Betzy the
flags involving <em>-xavx</em>, <em>-xavx2</em> and <em>-xcore-avx2</em> can cause
problems. As the -x prefix implies it will only generate code for a
processor supporting AVX and AVX2. Intel has implemented a run time
processor check for any program compiled with these flags. This only
apply to the main routine.  If the main() function is not compiler
with <em>-xavx</em>/<em>-xavx2</em> flags the test is not inserted and performance
is as expected.</p>
<p>There are a large range of other flags, and while the web
documentation is very good it can be overwhelming. A simple trick is
to issue the following command <code class="docutils literal notranslate"><span class="pre">icc</span> <span class="pre">-help</span> <span class="pre">&gt;</span> <span class="pre">icc.hpl</span></code> and open the file
in an editor and search and read relevant paragraphs. Except from
language specific flags most of the flags are similar for C/C++ and
Fortran.</p>
<p>The flags related to optimisation reports can be useful, <em>-qopt-report</em>.
To generate a nice optimisation report some of the following flags could
be used.</p>
<ul class="simple">
<li><p>-qopt-report-help</p></li>
<li><p>-qopt-report=1 (any number from 1 through 5 are valid, 0 turn it off)</p></li>
<li><p>-qopt-report-file=&lt;file.opt.txt&gt;</p></li>
<li><p>-qopt-report-annotate</p></li>
</ul>
<p>An example is : <code class="docutils literal notranslate"><span class="pre">-qopt-report=5</span> <span class="pre">-O3</span> <span class="pre">-xavx2</span> <span class="pre">-g</span> <span class="pre">-S</span></code> which will generate
a comprehensive report and a file containing the generated
code. Reviewing this report and the code can be of great help in cases
where the compiler fail to optimise as expected.</p>
</div>
</div>
<div class="section" id="gnu">
<h3>GNU<a class="headerlink" href="#gnu" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id2">
<h4>Introduction<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>GNU compilers are an integral part of the Linux distribution. However,
the versions of the compilers that comes with the distribution are
generally not the newest version. Look for modules that supply a more
recent version. The compiles support C/C++ and Fortran.</p>
</div>
<div class="section" id="id3">
<h4>Documentation<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>The compilers have good man pages covering most of what is commonly needed. More deep
documentation is found here : https://gcc.gnu.org/onlinedocs/ .</p>
</div>
<div class="section" id="id4">
<h4>Compiler flags<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<p>The default settings of gcc/gfortran are not optimal for performance. A set of optimising flags are needed. The flag for OpenMP is <em>-fopenmp</em>.</p>
<p>There a lot of optimisers available, a list can be generated using the command
<code class="docutils literal notranslate"><span class="pre">gcc</span> <span class="pre">--help=optimizers</span></code></p>
<p>Some set of flags for optimisation include :</p>
<ul class="simple">
<li><p>-O2 (often use for only memory intensive applications)</p></li>
<li><p>-O3</p></li>
<li><p>-O3 -mfma -mavx2</p></li>
<li><p>-O3 -march=znver2 -mtune=znver2 (for AMD)</p></li>
<li><p>-O3 -march=skylake-avx512  (for Intel Skylake)</p></li>
</ul>
</div>
</div>
<div class="section" id="amd-aocc-llvm">
<h3>AMD AOCC/llvm<a class="headerlink" href="#amd-aocc-llvm" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id5">
<h4>Introduction<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<p>AMD support the development of compilers based on llvm. The Software development kit can be found at : https://developer.amd.com/tools-and-sdks/ .
C/C++ and Fortran are supported.</p>
</div>
<div class="section" id="id6">
<h4>Documentation<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<p>The AMD documentation is limited. Documentation can be found at the AMD developer
web site given above.</p>
</div>
<div class="section" id="id7">
<h4>Compiler flags<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<p>The llvm compiler show a huge range of compiler flags, the AMD
documentation provide a nice subset of relevant flags. The flag for
OpenMP is <em>-fopenmp</em>. A suggested flags to try is given below.</p>
<ul class="simple">
<li><p>-O3</p></li>
<li><p>-Ofast</p></li>
<li><p>-Ofast -march=znver2 -mtune=znver2  (for AMD)</p></li>
<li><p>-Ofast -march=znver2 -mavx2 -m3dnow (for AMD)</p></li>
</ul>
</div>
</div>
<div class="section" id="pgi">
<h3>PGI<a class="headerlink" href="#pgi" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id8">
<h4>Introduction<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<p>Portland Group compiler, known as PGI compiler is now a part of NVIDIA. The PGI web page
is still available : https://www.pgroup.com/index.htm .</p>
</div>
<div class="section" id="id9">
<h4>Documentation<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<p>Documentation can be found at : https://www.pgroup.com/resources/docs/20.4/x86/index.htm</p>
</div>
<div class="section" id="id10">
<h4>Compiler flags<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h4>
<p>Please review the documentation for an updated list of the suggested compiler flags.</p>
<p>A set of suggested flags are :</p>
<ul class="simple">
<li><p>-O3 -tp zen -Mvect=simd -Mcache_align -Mprefetch -Munroll  (for AMD)</p></li>
</ul>
</div>
</div>
<div class="section" id="performance-of-compilers">
<h3>Performance of compilers<a class="headerlink" href="#performance-of-compilers" title="Permalink to this headline">¶</a></h3>
<p>A test using the well known reference implementation of matrix matrix
(<a class="reference external" href="http://www.netlib.org/lapack/explore-html/d7/d2b/dgemm_8f_source.html">dgemm</a>)
multiplication is used for a simple test of the different compilers.</p>
<p>| Compiler      | Flags                               | Performance       |
| ————- |:———————————–:|——– ———:|
| GNU gfortran  | -O3 -march=znver2 -mtune=znver2     | 4.79 Gflops/s     |
| AOCC flang    | -Ofast -march=znver2 -mavx2 -m3dnow | 5.21 Gflops/s     |
| Intel ifort   | -O3 -xavx2                          | 26.39 Gflops/s    |</p>
<p>The Intel Fortran compiler do a remarkable job with this nested loop problem.</p>
</div>
</div>
<div class="section" id="performance-libraries">
<h2>Performance libraries<a class="headerlink" href="#performance-libraries" title="Permalink to this headline">¶</a></h2>
<div class="section" id="intel-mkl">
<h3>Intel MKL<a class="headerlink" href="#intel-mkl" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id11">
<h4>Introduction<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h4>
<p>The Intel Math Kernel Library comes with the compiler suite and is well known as
high performance library. It comes in both sequential and multi threaded functions
and is know for its very high performance.</p>
<p>MKL have wrappers for FFTW so no rewrite is needed to link any applications using
FFTW with MKL. Both Include files and library functions are provided.</p>
<p>When using the Intel compiler the compiling and linking is very simple, most
of the times is enough to just add <em>-mkl</em>. Adding <em>=sequential</em> or <em>=parallel</em>.</p>
<p>When using MKL with the GNU compilers some more work is often needed.
An example can provide some hints:
<code class="docutils literal notranslate"><span class="pre">-L$MKLROOT/lib/intel64</span> <span class="pre">-lmkl_gnu_thread</span> <span class="pre">-lmkl_avx2</span> <span class="pre">-lmkl_core</span> <span class="pre">-lmkl_rt</span></code>
The variable <em>MKLROOT</em> is set when the Intel module is loaded.</p>
<p>The following command can be of help when encounter missing symbols:
<code class="docutils literal notranslate"><span class="pre">nm</span> <span class="pre">-A</span> <span class="pre">$MKLROOT/lib/intel64/*</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">&lt;missing</span> <span class="pre">symbol&gt;</span></code>
Look for symbols with <em>T</em> (T means text,global - e.g. it’s available, U means undefined).</p>
</div>
<div class="section" id="id12">
<h4>Documentation<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h4>
<p>Online documentation can be found at :  https://software.intel.com/content/www/us/en/develop/documentation/mkl-linux-developer-guide/top.html</p>
<p>There is a link line helper available : https://software.intel.com/content/www/us/en/develop/articles/intel-mkl-link-line-advisor.html , this can often be of help.</p>
</div>
</div>
<div class="section" id="amd-aocl">
<h3>AMD AOCL<a class="headerlink" href="#amd-aocl" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id13">
<h4>Introduction<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h4>
<p>The AMD performance library provide a set of library functions optimised for the AMD processor.
The web page is : https://developer.amd.com/amd-aocl/ .</p>
</div>
<div class="section" id="id14">
<h4>Documentation<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h4>
<p>Documentation can be found at https://developer.amd.com/amd-aocl/ .</p>
</div>
</div>
<div class="section" id="performance">
<h3>Performance<a class="headerlink" href="#performance" title="Permalink to this headline">¶</a></h3>
<p>The same test using matrix matrix multiplication, Level 3 BLAS
function dgemm is used to test single core performance of the
libraries. The tests are run on a single node using a single core on
Betzy.</p>
<p>| Library | Link line                                                 | Performance     |
| ——- |:———————————————- ———-:|:——- ——-:|
| AOCL    | gfortran -o dgemm-test.x -O3 dgemm-test.f90 -L<span class="math notranslate nohighlight">\(LIB -lblis | 50.13 Gflops/s  |
| AOCL    | flang -o dgemm-test.x -O3 dgemm-test.f90 -L\)</span>LIB -lblis    | 50.13 Gflops/s  |
| MKL     | ifort -o dgemm-test.x -O3 dgemm-test.f90 -mkl=sequential  | 51.53 Gflops/s  |</p>
<p>Using the MLK library with AMD is straightforward. In order to get MKL
to select the correct AVX2 enabled routine a flag need to be set,
use : <code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">MKL_DEBUG_CPU_TYPE=5</span></code>.  This flag is no longer honoured
in the 2020 version of the MKL. Without support for this flag the
performance is significantly lower, one test showed about 48 Gflops/s.</p>
<p>At 50 Gflops/s per core the aggregate number is 6.4 Tflops/s quite a
bit more than what’s expected from these nodes. This is a nice example
of clock boost when using only a few cores, or in this case only one.</p>
</div>
</div>
<div class="section" id="mpi-libraries">
<h2>MPI libraries<a class="headerlink" href="#mpi-libraries" title="Permalink to this headline">¶</a></h2>
<div class="section" id="openmpi">
<h3>OpenMPI<a class="headerlink" href="#openmpi" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id15">
<h4>Introduction<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h4>
<p>The OpenMPI library are based on the old LAM MPI from Ohio
Supercomputing Center. This one of the most widely used MPI
implementations today. The web site is : https://www.open-mpi.org/ .</p>
<p>OpenMPI is supported on all the Sigma2 systems, with versions for both
GNU and Intel compilers, and in some cases some support for other
compilers.</p>
</div>
<div class="section" id="usage">
<h4>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h4>
<p>The compiler wrappers hiding the include and link environment are called:</p>
<ul class="simple">
<li><p>mpicc for C</p></li>
<li><p>mpicxx for C++</p></li>
<li><p>mpif90 for Fortran</p></li>
<li><p>mpff77 for Fortran</p></li>
</ul>
<p>In practice both mpif90 and mpif77 points to the same Fortran compiler. A quick check for
compiler versions is <code class="docutils literal notranslate"><span class="pre">mpif90</span> <span class="pre">-v</span></code>.</p>
<p>Compiler flags are propagated to the underlaying compiler.</p>
<p>To run programs the launched application mpirun is used (SLURM srun is
an option also). There are a range of options to OpenMPI’s mpirun of
which <code class="docutils literal notranslate"><span class="pre">--bind-to</span></code> and <code class="docutils literal notranslate"><span class="pre">--map-by</span></code> a the most important when running on
the Sigma2 systems using SLURM as the queue system set the number of
ranks and other run time parameters like list of hosts etc. This is normal
for MPI libraries built and installed with SLURM support.</p>
</div>
</div>
<div class="section" id="intel-mpi">
<h3>Intel MPI<a class="headerlink" href="#intel-mpi" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id16">
<h4>Introduction<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h4>
<p>The Intel MPI is part of the Intel compiler suite and is a widely used MPI implementation.
More information is found on-line at : https://software.intel.com/content/www/us/en/develop/tools/mpi-library.html .</p>
<p>Intel MPI is supported on all Sigma2 systems, but mostly for use with
the Intel compiler, it can however, to some extent be used with
GNU. The support is present.</p>
</div>
<div class="section" id="id17">
<h4>Usage<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h4>
<p>The compiler wrappers have different naming then many other MPI implementations.</p>
<ul class="simple">
<li><p>mpiicc for C</p></li>
<li><p>mpiicpc for C++</p></li>
<li><p>mpiifort for Fortran</p></li>
<li><p>mpicc  GNU C</p></li>
<li><p>mpigcc GNU C</p></li>
<li><p>mpicxx GNU C++</p></li>
<li><p>mpifc GNU Fortran</p></li>
</ul>
<p>There are a lot of environment variables to be used with Intel MPI, they all start with <em>I_MPI</em></p>
<ul class="simple">
<li><p>I_MPI_PIN</p></li>
<li><p>I_MPI_PIN_DOMAIN</p></li>
<li><p>I_MPI_PIN_PROCESSOR_EXCLUDE_LIST</p></li>
</ul>
<p>The variable <em>I_MPI_PIN_DOMAIN</em> is good when running hybrid codes,
setting it to the number of threads per rank will help the launcher to
place the ranks correct.
Setting <em>I_MPI_PIN_PROCESSOR_EXCLUDE_LIST=128-255</em> will make sure only
physical cores 0-127 are used for MPI ranks. This ensures that no two
ranks share the same physical core.</p>
<p>As with any of these variable and other please review the
documentation pointed to above and do some testing yourself before
employing in large production scale.</p>
<p>Running applications with Intel MPI is just like a simple as for
OpenMPI as Intel MPI also has support for SLURM. Just <code class="docutils literal notranslate"><span class="pre">mpirun</span> <span class="pre">./a.out</span></code>
is normally enough.</p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="compilers.html" class="btn btn-neutral float-right" title="Compilers" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../files_storage/performance.html" class="btn btn-neutral float-left" title="Storage performance tuning" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Sigma2/Metacenter

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>